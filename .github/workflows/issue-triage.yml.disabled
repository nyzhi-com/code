name: Issue Triage

on:
  issues:
    types: [opened, reopened, assigned]

permissions:
  issues: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  triage:
    name: Label new issues for triage
    runs-on: ubuntu-latest
    steps:
      - name: Maintain needs-triage label
        uses: actions/github-script@v7
        with:
          script: |
            const labelName = "needs-triage";
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const action = context.payload.action;

            if (action === "opened" || action === "reopened") {
              try {
                await github.rest.issues.getLabel({ owner, repo, name: labelName });
              } catch (error) {
                if (error.status !== 404) throw error;
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: labelName,
                  color: "ededed",
                  description: "Needs maintainer triage"
                });
              }

              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number,
                labels: [labelName]
              });
              return;
            }

            if (action === "assigned") {
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number,
                  name: labelName
                });
              } catch (error) {
                if (error.status !== 404) throw error;
              }
            }
