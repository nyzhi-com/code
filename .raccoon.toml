cla_required = true
triage_label = "needs-triage"
stale_days = 60
merge_method = "squash"

[[auto_label]]
label = "core"
paths = ["crates/core/**"]

[[auto_label]]
label = "cli"
paths = ["crates/cli/**"]

[[auto_label]]
label = "provider"
paths = ["crates/provider/**"]

[[auto_label]]
label = "auth"
paths = ["crates/auth/**"]

[[auto_label]]
label = "tui"
paths = ["crates/tui/**"]

[[auto_label]]
label = "config"
paths = ["crates/config/**"]

[[auto_label]]
label = "infra"
paths = ["infra/**", ".github/**"]

[[pipelines]]
name = "check"
on = ["push:master", "pull_request"]

[[pipelines.steps]]
name = "Format"
command = "cargo fmt --all -- --check"

[[pipelines.steps]]
name = "Clippy"
command = "cargo clippy --all-targets --all-features -- -D warnings"

[[pipelines.steps]]
name = "Test"
command = "cargo test --all"

[[pipelines]]
name = "release"
on = ["tag:v*"]

[[pipelines.steps]]
name = "Build and publish release"
command = """
set -e
VERSION=${RACCOON_REF#refs/tags/v}

for target in x86_64-unknown-linux-gnu aarch64-unknown-linux-gnu x86_64-apple-darwin aarch64-apple-darwin; do
  echo "[raccoon] building $target"
  cargo zigbuild --release --target $target -p nyzhi
done

declare -A TARGET_MAP=(
  [x86_64-unknown-linux-gnu]=nyzhi-linux-x86_64
  [aarch64-unknown-linux-gnu]=nyzhi-linux-aarch64
  [x86_64-apple-darwin]=nyzhi-darwin-x86_64
  [aarch64-apple-darwin]=nyzhi-darwin-aarch64
)

for target in "${!TARGET_MAP[@]}"; do
  name=${TARGET_MAP[$target]}
  mkdir -p pkg && cp target/$target/release/nyz pkg/
  tar czf ${name}.tar.gz -C pkg nyz && rm -rf pkg
  sha256sum ${name}.tar.gz | cut -d' ' -f1 > ${name}.sha256
  echo "[raccoon] uploading $name"
  curl -sf -X POST "$RACCOON_CALLBACK/api/jobs/$RACCOON_JOB_ID/artifact" \
    -H "Authorization: Bearer $RACCOON_TOKEN" \
    -F "file=@${name}.tar.gz" -F "name=${name}.tar.gz"
  curl -sf -X POST "$RACCOON_CALLBACK/api/jobs/$RACCOON_JOB_ID/artifact" \
    -H "Authorization: Bearer $RACCOON_TOKEN" \
    -F "file=@${name}.sha256" -F "name=${name}.sha256"
done

echo "[raccoon] all artifacts uploaded"
"""

